<input id="address" name="address" type="text" class="input input-bordered input-sm max-w-xs text-left sm:w-96 w-56 mb-1">
<input type="button" class="btn btn-primary btn-sm font-thin", value=<%= t 'defaults.search' %> , onclick="codeAddress()">
<div id='map' class="rounded-xl sm:w-96 w-72 h-96" onclick="touchAddress()"></div>

<%= form_with model: flower, local: true do |f| %>
  <div class="form-control hidden">
    <%= f.label :latitude %>
    <%= f.text_field :latitude %>
  </div>
  <div class="form-control hidden">
    <%= f.label :longitude %>
    <%= f.text_field :longitude %>
  </div>
  <div class="form-control">
    <%= f.label :address, class: "font-serif font-bold mt-7" %>
    <%= f.text_area :address, class: "textarea sm:w-96 w-72" %>
  </div>
  <div class="form-control mt-3">
    <%= f.label :datetime, class: "font-serif font-bold" %>
    <%= f.datetime_field :datetime, class: "input sm:w-96 w-72", placeholder: "日付を入力してください" %>
  </div>
  <div class="form-control mt-3">
    <%= f.label :name, class: "font-serif font-bold" %>
    <%= f.text_field :name, class: "input sm:w-96 w-72"%>
  </div>
  <div class="form-control mt-3">
    <%= f.label :status, class: "font-serif font-bold" %>
    <div class="rating rating-lg">
      <%= f.radio_button :status, :bad, class: "mask mask-star-2 bg-orange-400" %>
      <%= f.radio_button :status, :rather_bad, class: "mask mask-star-2 bg-orange-400" %>
      <%= f.radio_button :status, :usually, class: "mask mask-star-2 bg-orange-400", checked: true %>
      <%= f.radio_button :status, :good, class: "mask mask-star-2 bg-orange-400" %>
      <%= f.radio_button :status, :beautiful, class: "mask mask-star-2 bg-orange-400" %>
    </div>
  </div>
  <div class="form-group mt-3">
    <%= f.label :flower_image, class: "font-serif font-bold" %>
    <%= f.file_field :flower_image, onchange: 'previewImage()', class: "form-control file-input sm:w-96 w-72" %>
    <%= f.hidden_field :flower_image_cache %>
    <%= image_tag flower.flower_image_url, id: 'preview', class: "rounded-xl sm:w-96 sm:h-96 w-72 h-72 mt-5" %>
    <%= javascript_include_tag 'image' %>
  </div>
  <div class="flex justify-center">
    <%= f.submit class: "btn btn-primary font-light mt-5" %>
  </div>
<% end %>

<script>
let map
let geocoder
let Marker

function initMap(){
  geocoder = new google.maps.Geocoder()

  map = new google.maps.Map(document.getElementById('map'), {
    center:  {lat: 35.6723997, lng:139.7690174},  //東京駅
    zoom: 16,
  });
}

function touchAddress(){
  google.maps.event.addListener(map, 'click',
  function(event) {
    if (Marker){Marker.setMap(null)};
    Marker = new google.maps.Marker({
    position: event.latLng,
    map: map,
    icon: 'https://storage-box24.s3.ap-northeast-1.amazonaws.com/marker.png'
    });
    geocode();
  })
  function geocode(){  var geocoder = new google.maps.Geocoder();
    geocoder.geocode({ 'location': Marker.getPosition()},
      function(results, status) {
    if (status == google.maps.GeocoderStatus.OK && results[0]){
      document.getElementById('flower_address').value = results[0].formatted_address.replace(/^日本, /, '');
      document.getElementById('flower_latitude').value = results[0].geometry.location.lat();
      document.getElementById('flower_longitude').value = results[0].geometry.location.lng();
    }
    });
  }
}

function codeAddress(){
  let inputAddress = document.getElementById('address').value;
    geocoder.geocode( { 'address': inputAddress}, function(results, status) {
    if (status == 'OK') {
      map.setCenter(results[0].geometry.location);
    } else {
      alert('該当する結果がありませんでした：' + status);
    }
  });
}
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_CLOUD_API_KEY'] %>&callback=initMap" async defer></script>
